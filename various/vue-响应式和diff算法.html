<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>2.0虚拟DOM | 只道寻常的前端小站点</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/assets/logo.svg">
    <meta name="description" content="一些笔记和生活杂谈">
    
    <link rel="preload" href="/assets/css/0.styles.a7ac0671.css" as="style"><link rel="preload" href="/assets/js/app.30386755.js" as="script"><link rel="preload" href="/assets/js/2.1d87707d.js" as="script"><link rel="preload" href="/assets/js/40.61d90dc9.js" as="script"><link rel="prefetch" href="/assets/js/10.f187c38e.js"><link rel="prefetch" href="/assets/js/11.a2cfd7d3.js"><link rel="prefetch" href="/assets/js/12.172a03c8.js"><link rel="prefetch" href="/assets/js/13.1b18bfcf.js"><link rel="prefetch" href="/assets/js/14.743ab3bd.js"><link rel="prefetch" href="/assets/js/15.82ffff1b.js"><link rel="prefetch" href="/assets/js/16.ee1bfe61.js"><link rel="prefetch" href="/assets/js/17.eb3d4a5a.js"><link rel="prefetch" href="/assets/js/18.9bcac279.js"><link rel="prefetch" href="/assets/js/19.f5e0e05a.js"><link rel="prefetch" href="/assets/js/20.b2e6d5c9.js"><link rel="prefetch" href="/assets/js/21.3786092e.js"><link rel="prefetch" href="/assets/js/22.371ac28b.js"><link rel="prefetch" href="/assets/js/23.5fc3bec3.js"><link rel="prefetch" href="/assets/js/24.606fb208.js"><link rel="prefetch" href="/assets/js/25.94e0f4d3.js"><link rel="prefetch" href="/assets/js/26.69ba41cd.js"><link rel="prefetch" href="/assets/js/27.6d837a58.js"><link rel="prefetch" href="/assets/js/28.dff1ab47.js"><link rel="prefetch" href="/assets/js/29.21117ab2.js"><link rel="prefetch" href="/assets/js/3.06ac1e4a.js"><link rel="prefetch" href="/assets/js/30.b02ee247.js"><link rel="prefetch" href="/assets/js/31.b0d15d1e.js"><link rel="prefetch" href="/assets/js/32.4ba9178d.js"><link rel="prefetch" href="/assets/js/33.f3a5e69f.js"><link rel="prefetch" href="/assets/js/34.2c62ff95.js"><link rel="prefetch" href="/assets/js/35.f6783a61.js"><link rel="prefetch" href="/assets/js/36.755b9357.js"><link rel="prefetch" href="/assets/js/37.960d1695.js"><link rel="prefetch" href="/assets/js/38.9e782115.js"><link rel="prefetch" href="/assets/js/39.91e5aa93.js"><link rel="prefetch" href="/assets/js/4.71ddf4d5.js"><link rel="prefetch" href="/assets/js/41.d13d89c2.js"><link rel="prefetch" href="/assets/js/42.52a32d49.js"><link rel="prefetch" href="/assets/js/43.6ea71cec.js"><link rel="prefetch" href="/assets/js/44.fffc6cae.js"><link rel="prefetch" href="/assets/js/45.c33098d6.js"><link rel="prefetch" href="/assets/js/46.38c1b29f.js"><link rel="prefetch" href="/assets/js/47.6a79485a.js"><link rel="prefetch" href="/assets/js/48.788c6504.js"><link rel="prefetch" href="/assets/js/49.50833b53.js"><link rel="prefetch" href="/assets/js/5.8ef9cb65.js"><link rel="prefetch" href="/assets/js/50.d5e85ab5.js"><link rel="prefetch" href="/assets/js/6.44cd9b24.js"><link rel="prefetch" href="/assets/js/7.8d0fa6a7.js"><link rel="prefetch" href="/assets/js/8.3995213f.js"><link rel="prefetch" href="/assets/js/9.c0b846a1.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a7ac0671.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">只道寻常的前端小站点</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/factory/" class="nav-link">
  项目开发好用工具
</a></div><div class="nav-item"><a href="/optimization/" class="nav-link">
  优化方案集
</a></div><div class="nav-item"><a href="/tags/" class="nav-link">
  标签
</a></div><div class="nav-item"><a href="/vue/" class="nav-link">
  vue不间断更新
</a></div><div class="nav-item"><a href="/various/" class="nav-link router-link-active">
  杂七杂八的文章
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/factory/" class="nav-link">
  项目开发好用工具
</a></div><div class="nav-item"><a href="/optimization/" class="nav-link">
  优化方案集
</a></div><div class="nav-item"><a href="/tags/" class="nav-link">
  标签
</a></div><div class="nav-item"><a href="/vue/" class="nav-link">
  vue不间断更新
</a></div><div class="nav-item"><a href="/various/" class="nav-link router-link-active">
  杂七杂八的文章
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>杂七杂八的文章</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/various/ vue-打开网站页面时判断若未登录自动跳转到登录页.html" class="sidebar-link">打开网站页面时判断若未登录自动跳转到登录页</a></li><li><a href="/various/2022-03-02-homebrew安装及问题记录.html" class="sidebar-link">homebrew安装过程及问题记录</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/various/2022-03-03-博客搭建不完全记录.html" class="sidebar-link">博客搭建不完全记录</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/various/2022-03-03-博客搭建不完全记录.html#一、使用的插件" class="sidebar-link">一、使用的插件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/various/2022-03-03-博客搭建不完全记录.html#_1-头部-nav-导航栏自动生成" class="sidebar-link">1. 头部 nav 导航栏自动生成</a></li><li class="sidebar-sub-header"><a href="/various/2022-03-03-博客搭建不完全记录.html#_2-侧边栏-navbar-自动生成" class="sidebar-link">2. 侧边栏 navbar 自动生成</a></li><li class="sidebar-sub-header"><a href="/various/2022-03-03-博客搭建不完全记录.html#_3-文件中文命名在路径链接中转为拼音显示" class="sidebar-link">3. 文件中文命名在路径链接中转为拼音显示</a></li><li class="sidebar-sub-header"><a href="/various/2022-03-03-博客搭建不完全记录.html#_4-加载进度条显示" class="sidebar-link">4.加载进度条显示</a></li></ul></li><li class="sidebar-sub-header"><a href="/various/2022-03-03-博客搭建不完全记录.html#二、-markdown-文件中的配置说明" class="sidebar-link">二、 markdown 文件中的配置说明</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/various/2022-03-03-博客搭建不完全记录.html#_1-title-文章大标题" class="sidebar-link">1. title: 文章大标题</a></li><li class="sidebar-sub-header"><a href="/various/2022-03-03-博客搭建不完全记录.html#_2-displayallheaders-true" class="sidebar-link">2. displayAllHeaders: true</a></li><li class="sidebar-sub-header"><a href="/various/2022-03-03-博客搭建不完全记录.html#_3-sidebardepth" class="sidebar-link">3. sidebarDepth</a></li><li class="sidebar-sub-header"><a href="/various/2022-03-03-博客搭建不完全记录.html#_4-autoignore-true" class="sidebar-link">4. autoIgnore: true</a></li><li class="sidebar-sub-header"><a href="/various/2022-03-03-博客搭建不完全记录.html#_5-autonav" class="sidebar-link">5. autonav</a></li></ul></li></ul></li><li><a href="/various/2022-03-04-blog-todo.html" class="sidebar-link">待办事项</a></li><li><a href="/various/2022-03-07-git常用命令.html" class="sidebar-link">git 常用命令</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/various/2022-03-07-npm日常使用.html" class="sidebar-link">2022-03-07-npm日常使用</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/various/2022-03-11-npm报错记录.html" class="sidebar-link">!image</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/various/2022-03-11-python升级.html" class="sidebar-link">python升级</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/various/2022-03-11-rxjs.html" class="sidebar-link">rxjs常用语法记录</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/various/2022-03-11-好文章请看这.html" class="sidebar-link">好文章请看这里</a></li><li><a href="/various/antd vue组件问题.html" class="sidebar-link">/various/antd vue组件问题.html</a></li><li><a href="/various/babel-polyfill——解决Vue2+Webpack+ES6 兼容低版本浏览器（IE9）.html" class="sidebar-link">/various/babel-polyfill——解决Vue2+Webpack+ES6 兼容低版本浏览器（IE9）.html</a></li><li><a href="/various/css攻略——flex布局.html" class="sidebar-link">flex 布局</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/various/css攻略——flex布局.html#flex-布局" class="sidebar-link">flex 布局</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/various/css攻略——flex布局.html#_1-老版本-flex-display-box" class="sidebar-link">1. 老版本 flex（display: box）</a></li><li class="sidebar-sub-header"><a href="/various/css攻略——flex布局.html#_2-新版本-flex-display-flex" class="sidebar-link">2. 新版本 flex（display: flex）</a></li></ul></li></ul></li><li><a href="/various/git-git-ssh key配置.html" class="sidebar-link">配置ssh</a></li><li><a href="/various/js-jasmine测试语法.html" class="sidebar-link">jest测试常用语法</a></li><li><a href="/various/js-rxjs常用语法.html" class="sidebar-link">rxjs常用操作</a></li><li><a href="/various/js-常用正则.html" class="sidebar-link">常用正则表达式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/various/js-常用正则.html#常用正则表达式" class="sidebar-link">常用正则表达式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/various/js-常用正则.html#一、校验数字的表达式" class="sidebar-link">一、校验数字的表达式</a></li><li class="sidebar-sub-header"><a href="/various/js-常用正则.html#二、校验字符的表达式" class="sidebar-link">二、校验字符的表达式</a></li><li class="sidebar-sub-header"><a href="/various/js-常用正则.html#三、特殊需求表达式" class="sidebar-link">三、特殊需求表达式</a></li></ul></li></ul></li><li><a href="/various/js-浏览器渲染原理.html" class="sidebar-link">浏览器渲染核心</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/various/js-浏览器渲染原理.html#差异" class="sidebar-link">差异：</a></li><li class="sidebar-sub-header"><a href="/various/js-浏览器渲染原理.html#总结" class="sidebar-link">总结：</a></li></ul></li><li><a href="/various/js-精度缺失.html" class="sidebar-link">精度丢失</a></li><li><a href="/various/js-输入框之表情替换.html" class="sidebar-link">输入框之表情替换</a></li><li><a href="/various/mac安装软件常遇问题“xx”已损坏，无法打开，你应将它移废纸蒌.html" class="sidebar-link">macOS遇见的问题</a></li><li><a href="/various/path.resolve和path.join的区别.html" class="sidebar-link">path.resolve和path.join的区别.md</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/various/vscode-vue模板语法.html" class="sidebar-link">在 vscode 中设置模板语法，可以直接使用“vue + 回车键”创 vue 文件中的 vue 内容</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/various/vscode-vue模板语法.html#在-vscode-中设置模板语法-可以直接使用-vue-回车键-创-vue-文件中的-vue-内容" class="sidebar-link">在 vscode 中设置模板语法，可以直接使用“vue + 回车键”创 vue 文件中的 vue 内容</a></li></ul></li><li><a href="/various/vscode-使用eslint-未完成.html" class="sidebar-link">安装vscode中eslint的插件</a></li><li><a href="/various/vscode-快捷键使用.html" class="sidebar-link">vscode操作指南</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/various/vscode-快捷键使用.html#vscode操作指南" class="sidebar-link">vscode操作指南</a></li></ul></li><li><a href="/various/vscode新建token.html" class="sidebar-link">vscode中github新建token</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/various/vscode新建token.html#vscode中github新建token" class="sidebar-link">vscode中github新建token</a></li></ul></li><li><a href="/various/vue-响应式和diff算法.html" class="active sidebar-link">2.0虚拟DOM</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/various/vue-响应式和diff算法.html#_2-0虚拟dom" class="sidebar-link">2.0虚拟DOM</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/various/vue-响应式和diff算法.html#虚拟dom的概念" class="sidebar-link">虚拟dom的概念</a></li><li class="sidebar-sub-header"><a href="/various/vue-响应式和diff算法.html#优点" class="sidebar-link">优点</a></li><li class="sidebar-sub-header"><a href="/various/vue-响应式和diff算法.html#实现" class="sidebar-link">实现</a></li></ul></li><li class="sidebar-sub-header"><a href="/various/vue-响应式和diff算法.html#vue3-0的虚拟dom" class="sidebar-link">Vue3.0的虚拟DOM</a></li></ul></li><li><a href="/various/vue项目配置icon和webapk链式操作.html" class="sidebar-link">vue 项目配置 icon 和 webapk 链式操作</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/various/vue项目配置icon和webapk链式操作.html#vue-项目配置-icon-和-webapk-链式操作" class="sidebar-link">vue 项目配置 icon 和 webapk 链式操作</a></li></ul></li><li><a href="/various/命令行使用——git常用命令.html" class="sidebar-link">git常用命令</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/various/命令行使用——git常用命令.html#git常用命令" class="sidebar-link">git常用命令</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/various/命令行使用——git常用命令.html#查看本地所有分枝" class="sidebar-link">查看本地所有分枝</a></li><li class="sidebar-sub-header"><a href="/various/命令行使用——git常用命令.html#查看远程所有分支" class="sidebar-link">查看远程所有分支</a></li><li class="sidebar-sub-header"><a href="/various/命令行使用——git常用命令.html#_2-拉取本地没有的远程分支" class="sidebar-link">2. 拉取本地没有的远程分支</a></li><li class="sidebar-sub-header"><a href="/various/命令行使用——git常用命令.html#_3-提交修改并推送到远程分支" class="sidebar-link">3. 提交修改并推送到远程分支</a></li><li class="sidebar-sub-header"><a href="/various/命令行使用——git常用命令.html#删除本地分支" class="sidebar-link">删除本地分支</a></li><li class="sidebar-sub-header"><a href="/various/命令行使用——git常用命令.html#删除本地全部分支" class="sidebar-link">删除本地全部分支</a></li><li class="sidebar-sub-header"><a href="/various/命令行使用——git常用命令.html#获取某次提交的代码" class="sidebar-link">获取某次提交的代码</a></li><li class="sidebar-sub-header"><a href="/various/命令行使用——git常用命令.html#git-stash-的使用" class="sidebar-link">git stash 的使用</a></li><li class="sidebar-sub-header"><a href="/various/命令行使用——git常用命令.html#打tag标签" class="sidebar-link">打tag标签</a></li></ul></li></ul></li><li><a href="/various/命令行使用——配置环境变量.html" class="sidebar-link">mac中host配置</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/various/命令行使用——配置环境变量.html#mac中host配置" class="sidebar-link">mac中host配置</a></li></ul></li><li><a href="/various/图床的使用-代替其他网盘之类的存储个人图片.html" class="sidebar-link">/various/图床的使用-代替其他网盘之类的存储个人图片.html</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/various/图床的使用-代替其他网盘之类的存储个人图片.html#ghp-5z5t1ubso9tgqxnqpizbbhk1zkoy9h4fbxsr" class="sidebar-link">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</a></li></ul></li><li><a href="/various/工具使用-有道云笔记中引入图片.html" class="sidebar-link">1. 将图片存储到有道云中</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/various/工具使用-有道云笔记中引入图片.html#_1-将图片存储到有道云中" class="sidebar-link">1. 将图片存储到有道云中</a></li><li class="sidebar-sub-header"><a href="/various/工具使用-有道云笔记中引入图片.html#_2-将分享的图片地址复制下来" class="sidebar-link">2. 将分享的图片地址复制下来</a></li></ul></li><li><a href="/various/日常零碎内容整理.html" class="sidebar-link">/various/日常零碎内容整理.html</a></li><li><a href="/various/跨域——access-control-allow-XX设置 跨域资源共享cors详解,promise,.html" class="sidebar-link">access-control-allow-origin的设置</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="_2-0虚拟dom"><a href="#_2-0虚拟dom" class="header-anchor">#</a> 2.0虚拟DOM</h2> <h3 id="虚拟dom的概念"><a href="#虚拟dom的概念" class="header-anchor">#</a> 虚拟dom的概念</h3> <p>&amp; 虚拟dom图</p> <p>// 打补丁</p> <p>// 基于snabdom库</p> <h3 id="优点"><a href="#优点" class="header-anchor">#</a> 优点</h3> <ul><li><p>轻量、快速：介于js操作和真实dom之间，当数据发生变化的时候，通过新旧虚拟dom的比对得到最小dom操作量，然后进行数据更新</p></li> <li><p>跨平台：将虚拟dom更新转换为不同运行时特殊操作实现跨平台</p></li> <li><p>兼容性：还可以加入兼容性代码增强操作的兼容性</p></li></ul> <h5 id=""><a href="#" class="header-anchor">#</a></h5> <h5 id="必要性"><a href="#必要性" class="header-anchor">#</a> ** 必要性**</h5> <p>// watcher粒度上的需求性</p> <p>// vue1.0 2.0 30.比较，改进优化的必要性</p> <p>vue 1.0中有细粒度的数据变化侦测，它是不需要虚拟DOM的，但是细粒度造成了大量开销，这对于大型项目来说是不可接受的。</p> <p>因此，vue 2.0选择了中等粒度的解决方案，每一个组件一个watcher实例， 这样只有组件数据状态变化时才会通知到组件，接着再通过引入虚拟DOM去对新旧DOM进行比对并对页面进行渲染。</p> <p>3.0</p> <h3 id="实现"><a href="#实现" class="header-anchor">#</a> 实现</h3> <h4 id="渲染更新组件"><a href="#渲染更新组件" class="header-anchor">#</a> 渲染更新组件</h4> <p>core/instance/lifecycle.js 方法 mountComponent()</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 定义组件更新函数 </span>
<span class="token function-variable function">updateComponent</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> 
<span class="token comment">// 实际调用是在lifeCycleMixin中定义的_update和renderMixin中定义的_render </span>
vm<span class="token punctuation">.</span><span class="token function">_update</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">_render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> hydrating<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><p>_render 执行获取虚拟dom， VNode</p></li> <li><p>_update 将虚拟dom转成真createPatchFunction实dom</p> <p><strong>_update转换分为两步：</strong></p> <ul><li>1）初始化直接转换成真实dom</li> <li>2）更新流程 使用diff算法进行新dom 旧dom  的替换</li></ul></li></ul> <p><strong>查看以下demo的console结果</strong></p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>demo<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>虚拟DOM<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>{{foo}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>../../dist/vue.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">el</span><span class="token operator">:</span> <span class="token string">&quot;#demo&quot;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">foo</span><span class="token operator">:</span> <span class="token string">&quot;foo&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>$options<span class="token punctuation">.</span>render<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>渲染函数最后的生成结果</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 生成一个匿名函数</span>
<span class="token comment">// _c() 就是render(h){}中的h函数，也就是createElemet()</span>
<span class="token comment">// _v 文本节点</span>
<span class="token comment">// _s 格式化</span>
ƒ <span class="token function">anonymous</span><span class="token punctuation">(</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">with</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">_c</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
            <span class="token literal-property property">attrs</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token string-property property">&quot;id&quot;</span><span class="token operator">:</span><span class="token string">&quot;demo&quot;</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">[</span>
            <span class="token function">_c</span><span class="token punctuation">(</span><span class="token string">'h1'</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token function">_v</span><span class="token punctuation">(</span><span class="token string">&quot;虚拟DOM&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">_v</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
           	<span class="token function">_c</span><span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token function">_v</span><span class="token punctuation">(</span><span class="token function">_s</span><span class="token punctuation">(</span>foo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="render函数的定义"><a href="#render函数的定义" class="header-anchor">#</a> _render函数的定义</h4> <p>src/core/instance/index.js 调用了</p> <div class="language- extra-class"><pre class="language-text"><code>//* _update 所在函数
lifecycleMixin(Vue) 
// * $nextTick _render所在的函数
renderMixin(Vue) 
</code></pre></div><p>src/core/instance/render.js 定义了renderMixin</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// render函数 实现了$nextTick和_render</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">renderMixin</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">Vue</span><span class="token operator">:</span> Class<span class="token operator">&lt;</span>Component<span class="token operator">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$nextTick</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">fn</span><span class="token operator">:</span> Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">nextTick</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_render</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> VNode <span class="token punctuation">{</span> <span class="token comment">//返回的是VNode</span>
    <span class="token keyword">const</span> <span class="token literal-property property">vm</span><span class="token operator">:</span> Component <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> render<span class="token punctuation">,</span> _parentVnode <span class="token punctuation">}</span> <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options
    vm<span class="token punctuation">.</span>$vnode <span class="token operator">=</span> _parentVnode
    <span class="token comment">// render self</span>
    <span class="token keyword">let</span> vnode <span class="token operator">=</span> <span class="token function">render</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_renderProxy<span class="token punctuation">,</span> vm<span class="token punctuation">.</span>$createElement<span class="token punctuation">)</span>
    <span class="token comment">// if the returned array contains only a single node, allow it</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> vnode<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      vnode <span class="token operator">=</span> vnode<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// return empty vnode in case the render function errored out</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>vnode <span class="token keyword">instanceof</span> <span class="token class-name">VNode</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      vnode <span class="token operator">=</span> <span class="token function">createEmptyVNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// set parent</span>
    vnode<span class="token punctuation">.</span>parent <span class="token operator">=</span> _parentVnode
    <span class="token keyword">return</span> vnode
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>src/core/instance/render.js 中的initRender()</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// *render中的h()函数,虚拟dom的生成函数</span>
<span class="token comment">//编译器render函数生成</span>
  vm<span class="token punctuation">.</span><span class="token function-variable function">_c</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">createElement</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token comment">// 用户render函数生成</span>
  vm<span class="token punctuation">.</span><span class="token function-variable function">$createElement</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">createElement</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
</code></pre></div><p>src/core/vdom/create-element.js</p> <div class="language- extra-class"><pre class="language-text"><code> _createElement(context, tag, data, children, normalizationType)
</code></pre></div><p>_createElement()</p> <p>创建虚拟DOM</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/** 创建标签的时候，先判断是否是原生标签**/</span>
<span class="token comment">// * 根据标签执行相应操作,标签为string类型时</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> tag <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">isReservedTag</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//   原生标签直接创建虚拟DOM</span>
      vnode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VNode</span><span class="token punctuation">(</span>
        config<span class="token punctuation">.</span><span class="token function">parsePlatformTagName</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">,</span> data<span class="token punctuation">,</span> children<span class="token punctuation">,</span>
        <span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> context
      <span class="token punctuation">)</span>
    <span class="token comment">//   自定义组件</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">!</span>data <span class="token operator">||</span> <span class="token operator">!</span>data<span class="token punctuation">.</span>pre<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>Ctor <span class="token operator">=</span> <span class="token function">resolveAsset</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>$options<span class="token punctuation">,</span> <span class="token string">'components'</span><span class="token punctuation">,</span> tag<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// component</span>
      <span class="token comment">// * 根据组件的构造函数自定义组件</span>
      vnode <span class="token operator">=</span> <span class="token function">createComponent</span><span class="token punctuation">(</span>Ctor<span class="token punctuation">,</span> data<span class="token punctuation">,</span> context<span class="token punctuation">,</span> children<span class="token punctuation">,</span> tag<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      vnode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VNode</span><span class="token punctuation">(</span>
        tag<span class="token punctuation">,</span> data<span class="token punctuation">,</span> children<span class="token punctuation">,</span>
        <span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> context
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// direct component options / constructor</span>
        <span class="token comment">// 传进来的标签不是字符串</span>
        vnde <span class="token operator">=</span> <span class="token function">createComponent</span><span class="token punctuation">(</span>tag<span class="token punctuation">,</span> data<span class="token punctuation">,</span> context<span class="token punctuation">,</span> children<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
    <span class="token comment">// 传进来的标签不是字符串的情况下直接创建</span>
    vnode <span class="token operator">=</span> <span class="token function">createComponent</span><span class="token punctuation">(</span>tag<span class="token punctuation">,</span> data<span class="token punctuation">,</span> context<span class="token punctuation">,</span> children<span class="token punctuation">)</span>

  <span class="token punctuation">}</span>
</code></pre></div><h4 id="update函数的执行"><a href="#update函数的执行" class="header-anchor">#</a> _update函数的执行</h4> <p>src/core/instance/lifecycle.js lifecycleMixin()</p> <p>Vue.prototype._update</p> <div class="language-js extra-class"><pre class="language-js"><code> <span class="token comment">// * 获取上次执行结果，旧的虚拟DOM</span>
    <span class="token keyword">const</span> prevVnode <span class="token operator">=</span> vm<span class="token punctuation">.</span>_vnode
    <span class="token comment">// 	上次执行结果没有，就是初始化过程</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>prevVnode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// * 初始化时，传入的 vm.$el 是真实DOM</span>
      vm<span class="token punctuation">.</span>$el <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">__patch__</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$el<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> hydrating<span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment">/* removeOnly */</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> 
    <span class="token comment">// 否则就是更新过程</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
      vm<span class="token punctuation">.</span>$el <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">__patch__</span><span class="token punctuation">(</span>prevVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>src/core/vdom/patch.js patchVnode所在位置</p> <p>Web/runtime/index.js 实现了patch方法</p> <div class="language- extra-class"><pre class="language-text"><code>Vue.prototype.__patch__ = inBrowser ? patch : noop
</code></pre></div><p>src/platforms/web/runtime/patch.js  patch 工厂函数，实现跨平台</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 根据传进来的平台类型，进行不同的patch操作</span>
<span class="token comment">// nodeOps：节点操作, modules：节点属性操作</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token literal-property property">patch</span><span class="token operator">:</span> Function <span class="token operator">=</span> <span class="token function">createPatchFunction</span><span class="token punctuation">(</span><span class="token punctuation">{</span> nodeOps<span class="token punctuation">,</span> modules <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>src/core/vdom/patch.js   定义createPatchFunction()方法</p> <p>通过<strong>同层的树节点进行比较</strong>而非对树进行逐层搜索遍历的方式，所以时间复杂度只有O(n)，降低了时间复杂度，是一种相当高效的算法。</p> <p>同层级只做三件事：增删改。</p> <p>具体规则是：</p> <ul><li><p>new VNode不存在就删；</p></li> <li><p>old VNode不存在就增；</p></li> <li><p>都存在就比较类型，类型不同直接替换、类型相同执行更新；</p></li></ul> <h5 id="patchvnode"><a href="#patchvnode" class="header-anchor">#</a> patchVnode</h5> <p>两个VNode类型相同，就执行更新操作，包括三种类型操作：<strong>属性更新PROPS</strong>、<strong>文本更新TEXT</strong>、<strong>子节点更新</strong></p> <h6 id="patchvnode具体规则如下"><a href="#patchvnode具体规则如下" class="header-anchor">#</a> patchVnode具体规则如下：</h6> <ol><li><p>如果新旧VNode都是<strong>静态的</strong>，那么只需要替换elm以及componentInstance即可。</p></li> <li><p>新老节点<strong>均有子节点</strong>，则对子节点进行diﬀ操作，调用<strong>updateChildren</strong></p></li> <li><p>如果<strong>老节点没有子节点而新节点存在子节点</strong>，先清空老节点DOM的文本内容，然后为当前DOM节   点加入子节点。</p></li> <li><p>当<strong>新节点没有子节点而老节点有子节点</strong>的时候，则移除该DOM节点的所有子节点。</p></li> <li><p>当<strong>新老节点都无子节点</strong>的时候，只是文本的替换。</p></li></ol> <img src="/Users/xyingliu/Desktop/v2-f9d6f677e54a61da09aa8d1ceba1f4bc_1440w.jpg" alt="v2-f9d6f677e54a61da09aa8d1ceba1f4bc_w" style="zoom:45%;"> <h6 id="静态节点判断"><a href="#静态节点判断" class="header-anchor">#</a> 静态节点判断</h6> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isTrue</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>isAsyncPlaceholder<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>asyncFactory<span class="token punctuation">.</span>resolved<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">hydrate</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        vnode<span class="token punctuation">.</span>isAsyncPlaceholder <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre></div><h6 id="属性更新"><a href="#属性更新" class="header-anchor">#</a> 属性更新</h6> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> i
<span class="token keyword">const</span> data <span class="token operator">=</span> vnode<span class="token punctuation">.</span>data
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> data<span class="token punctuation">.</span>hook<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>prepatch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">i</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// oldCh:旧节点 ch：新节点</span>
<span class="token keyword">const</span> oldCh <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>children
<span class="token keyword">const</span> ch <span class="token operator">=</span> vnode<span class="token punctuation">.</span>children
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isPatchable</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cbs<span class="token punctuation">.</span>update<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> cbs<span class="token punctuation">.</span>update<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> data<span class="token punctuation">.</span>hook<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>update<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">i</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">patchVnode</span> <span class="token punctuation">(</span>
 <span class="token parameter">oldVnode<span class="token punctuation">,</span>
 vnode<span class="token punctuation">,</span>
 insertedVnodeQueue<span class="token punctuation">,</span>
 ownerArray<span class="token punctuation">,</span>
 index<span class="token punctuation">,</span>
 removeOnly</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldVnode <span class="token operator">===</span> vnode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>elm<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>ownerArray<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        vnode <span class="token operator">=</span> ownerArray<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">cloneVNode</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> elm <span class="token operator">=</span> vnode<span class="token punctuation">.</span>elm <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>elm

    <span class="token comment">// 若是静态节点直接跳过，节约性能</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isTrue</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>isAsyncPlaceholder<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>asyncFactory<span class="token punctuation">.</span>resolved<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">hydrate</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            vnode<span class="token punctuation">.</span>isAsyncPlaceholder <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isTrue</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>isStatic<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token function">isTrue</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>isStatic<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        vnode<span class="token punctuation">.</span>key <span class="token operator">===</span> oldVnode<span class="token punctuation">.</span>key <span class="token operator">&amp;&amp;</span>
        <span class="token punctuation">(</span><span class="token function">isTrue</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>isCloned<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">isTrue</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>isOnce<span class="token punctuation">)</span><span class="token punctuation">)</span>
       <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        vnode<span class="token punctuation">.</span>componentInstance <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>componentInstance
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    
    <span class="token keyword">let</span> i
    <span class="token keyword">const</span> data <span class="token operator">=</span> vnode<span class="token punctuation">.</span>data
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> data<span class="token punctuation">.</span>hook<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>prepatch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">i</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 1.oldCh:旧节点 ch：新节点</span>
    <span class="token keyword">const</span> oldCh <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>children
    <span class="token keyword">const</span> ch <span class="token operator">=</span> vnode<span class="token punctuation">.</span>children
    <span class="token comment">// 2.属性更新</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isPatchable</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> cbs<span class="token punctuation">.</span>update<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> cbs<span class="token punctuation">.</span>update<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> data<span class="token punctuation">.</span>hook<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>update<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">i</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

 	<span class="token comment">// 3.新的节点里没文本</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>     
        <span class="token comment">// 新旧节点里都存在子节点,直接对比更新新旧子节点</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>oldCh <span class="token operator">!==</span> ch<span class="token punctuation">)</span> <span class="token function">updateChildren</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> ch<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> removeOnly<span class="token punctuation">)</span>

        <span class="token punctuation">}</span> 
        <span class="token comment">// 新节点存在子节点、老节点没有子节点，清空老节点中的text文本并增加新节点中的children</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">checkDuplicateKeys</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>text <span class="token punctuation">)</span><span class="token punctuation">)</span> nodeOps<span class="token punctuation">.</span><span class="token function">setTextContent</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
            <span class="token function">addVnodes</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> ch<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ch<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> 

        <span class="token comment">// 新节点不存在子节点、老节点有子节点，删除子节点</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">removeVnodes</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> oldCh<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> 
        <span class="token comment">// 新旧都有子节点，直接替换</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            nodeOps<span class="token punctuation">.</span><span class="token function">setTextContent</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> 
     <span class="token comment">// 4.有文本，内容不一样，直接替换</span>
     <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>text <span class="token operator">!==</span> vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        nodeOps<span class="token punctuation">.</span><span class="token function">setTextContent</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> data<span class="token punctuation">.</span>hook<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>i <span class="token operator">=</span> i<span class="token punctuation">.</span>postpatch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">i</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>updateComponent</p> <div class="language-js extra-class"><pre class="language-js"><code>   <span class="token comment">/** 假设头尾有可能相同
     * 新节点开始：nS 新节点结束nE 旧节点开始oS 旧节点结束oE
     * 
     * */</span>   
  <span class="token keyword">function</span> <span class="token function">updateChildren</span> <span class="token punctuation">(</span><span class="token parameter">parentElm<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> newCh<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> removeOnly</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 设置首尾4个index以及相对应的节点</span>
    <span class="token keyword">let</span> oldStartIdx <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">let</span> newStartIdx <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">let</span> oldEndIdx <span class="token operator">=</span> oldCh<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>
    <span class="token keyword">let</span> oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">let</span> oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span>oldEndIdx<span class="token punctuation">]</span>
    <span class="token keyword">let</span> newEndIdx <span class="token operator">=</span> newCh<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>
    <span class="token keyword">let</span> newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">let</span> newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span>newEndIdx<span class="token punctuation">]</span>
    <span class="token keyword">let</span> oldKeyToIdx<span class="token punctuation">,</span> idxInOld<span class="token punctuation">,</span> vnodeToMove<span class="token punctuation">,</span> refElm

    <span class="token comment">// removeOnly is a special flag used only by &lt;transition-group&gt;</span>
    <span class="token comment">// to ensure removed elements stay in correct relative positions</span>
    <span class="token comment">// during leaving transitions</span>
    <span class="token keyword">const</span> canMove <span class="token operator">=</span> <span class="token operator">!</span>removeOnly

    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">checkDuplicateKeys</span><span class="token punctuation">(</span>newCh<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//开始循环：结束条件开始的index不能超过结束index</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>oldStartIdx <span class="token operator">&lt;=</span> oldEndIdx <span class="token operator">&amp;&amp;</span> newStartIdx <span class="token operator">&lt;=</span> newEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">// 静态节点直接增加或删除</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span> <span class="token comment">// Vnode has been moved left</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span>
      <span class="token punctuation">}</span> 
        <span class="token comment">// 新旧节点开始位置节点相同</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> newCh<span class="token punctuation">,</span> newStartIdx<span class="token punctuation">)</span>
        <span class="token comment">// 开始的index分别加1</span>
        oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span>
        newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span>
      <span class="token punctuation">}</span> 
        <span class="token comment">// 新旧节点结束位置节点相同</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> newCh<span class="token punctuation">,</span> newEndIdx<span class="token punctuation">)</span>
        <span class="token comment">// // 结束的index分别减1</span>
        oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span>
        newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">--</span>newEndIdx<span class="token punctuation">]</span>
      <span class="token punctuation">}</span> 
        <span class="token comment">// 旧节点开始和新节点结束相同</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// Vnode moved right</span>
        <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> newCh<span class="token punctuation">,</span> newEndIdx<span class="token punctuation">)</span>
        <span class="token comment">// 旧节点的开始移动到队尾</span>
        canMove <span class="token operator">&amp;&amp;</span> nodeOps<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> nodeOps<span class="token punctuation">.</span><span class="token function">nextSibling</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">.</span>elm<span class="token punctuation">)</span><span class="token punctuation">)</span>
        oldStartVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">++</span>oldStartIdx<span class="token punctuation">]</span>
        newEndVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">--</span>newEndIdx<span class="token punctuation">]</span>
      <span class="token punctuation">}</span> 
        <span class="token comment">// 旧节点结束和新节点开始相同</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// Vnode moved left</span>
        <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> newCh<span class="token punctuation">,</span> newStartIdx<span class="token punctuation">)</span>
        <span class="token comment">// 旧节点结束移动到队首</span>
        canMove <span class="token operator">&amp;&amp;</span> nodeOps<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> oldEndVnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">)</span>
        oldEndVnode <span class="token operator">=</span> oldCh<span class="token punctuation">[</span><span class="token operator">--</span>oldEndIdx<span class="token punctuation">]</span>
        newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// 首尾没有找到相同的，从新的开头拿出一个节点，去老的数组查找</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>oldKeyToIdx<span class="token punctuation">)</span><span class="token punctuation">)</span> oldKeyToIdx <span class="token operator">=</span> <span class="token function">createKeyToOldIdx</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">,</span> oldStartIdx<span class="token punctuation">,</span> oldEndIdx<span class="token punctuation">)</span>
        idxInOld <span class="token operator">=</span> <span class="token function">isDef</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">.</span>key<span class="token punctuation">)</span>
          <span class="token operator">?</span> oldKeyToIdx<span class="token punctuation">[</span>newStartVnode<span class="token punctuation">.</span>key<span class="token punctuation">]</span>
          <span class="token operator">:</span> <span class="token function">findIdxInOld</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> oldStartIdx<span class="token punctuation">,</span> oldEndIdx<span class="token punctuation">)</span>
        <span class="token comment">// 旧节点没有，新节点增加</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>idxInOld<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">createElm</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> parentElm<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> newCh<span class="token punctuation">,</span> newStartIdx<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
          <span class="token comment">// 新旧都有，更新</span>
          <span class="token keyword">else</span> <span class="token punctuation">{</span>
          vnodeToMove <span class="token operator">=</span> oldCh<span class="token punctuation">[</span>idxInOld<span class="token punctuation">]</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>vnodeToMove<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">patchVnode</span><span class="token punctuation">(</span>vnodeToMove<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> newCh<span class="token punctuation">,</span> newStartIdx<span class="token punctuation">)</span>
            oldCh<span class="token punctuation">[</span>idxInOld<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">undefined</span>
            canMove <span class="token operator">&amp;&amp;</span> nodeOps<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> vnodeToMove<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// same key but different element. treat as new element</span>
            <span class="token function">createElm</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> parentElm<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> newCh<span class="token punctuation">,</span> newStartIdx<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldStartIdx <span class="token operator">&gt;</span> oldEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 旧开始节点大于旧结束节点，剩余新节点新增</span>
      refElm <span class="token operator">=</span> <span class="token function">isUndef</span><span class="token punctuation">(</span>newCh<span class="token punctuation">[</span>newEndIdx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> newCh<span class="token punctuation">[</span>newEndIdx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>elm
      <span class="token function">addVnodes</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> refElm<span class="token punctuation">,</span> newCh<span class="token punctuation">,</span> newStartIdx<span class="token punctuation">,</span> newEndIdx<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newStartIdx <span class="token operator">&gt;</span> newEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 新开始节点大于新结束节点，剩余旧节点删除</span>
      <span class="token function">removeVnodes</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">,</span> oldStartIdx<span class="token punctuation">,</span> oldEndIdx<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>整体流程</p> <h2 id="vue3-0的虚拟dom"><a href="#vue3-0的虚拟dom" class="header-anchor">#</a> Vue3.0的虚拟DOM</h2> <p>使用proxy代替deficreatePatchFunctionneReactive</p> <ol><li><p>Vue2.0中defineReactive只能对object的一个key进行监听，所以当object有很多可，或者有深度嵌套的时候，我想要对所有的key进行监听，就需要做深层遍历。</p></li> <li><p>在每一个key中有大量的数据去保存数据的变化，会形成很多闭包；而且为了建立数据和界面的依赖关系，会创建许多watcher和dep来保存依赖关系。所以这就造成了初始化速度慢，占用内存高。</p></li> <li><p>对于数组要做特殊的处理，修改数据时不能使用索引方法。动态添加或删除对象属性时，需要使用额外的API
vue3.0中使用到了proxy，proxy是懒处理，发现嵌套对象的时候才会进行递归。</p></li></ol> <p>vue2.0
视图更新patch过程：https://segmentfault.com/a/1190000021057420</p> <p>vue3.0</p> <ul><li>https://zhuanlan.zhihu.com/p/86067078</li> <li>https://www.cnblogs.com/fs0196/p/12691407.html</li> <li>https://juejin.cn/post/6844904134303301645#heading-14</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/various/vscode新建token.html" class="prev">
        vscode中github新建token
      </a></span> <span class="next"><a href="/various/vue项目配置icon和webapk链式操作.html">
        vue 项目配置 icon 和 webapk 链式操作
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.30386755.js" defer></script><script src="/assets/js/2.1d87707d.js" defer></script><script src="/assets/js/40.61d90dc9.js" defer></script>
  </body>
</html>
